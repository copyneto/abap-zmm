sap.ui.define([],                                                                                                                                                                                                                                              
    function () {                                                                                                                                                                                                                                              
        "use strict";                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        return {                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            aMessages: new Array(),                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            oMsgDialog: undefined,                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            onInit: function (oEvent) {                                                                                                                                                                                                                        
                this.oMsgDialog = new sap.m.Dialog({                                                                                                                                                                                                           
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message",                                                                                                                                                                                                                           
                    icon: "sap-icon://alert",                                                                                                                                                                                                                  
                    title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MessageViewTitle"),                                                                                                                                          
                    state: "Information",                                                                                                                                                                                                                      
                    contentHeight: "50%",                                                                                                                                                                                                                      
                    contentWidth: "50%",                                                                                                                                                                                                                       
                    verticalScrolling: false,                                                                                                                                                                                                                  
                    beginButton: new sap.m.Button({                                                                                                                                                                                                            
                        press: function () {                                                                                                                                                                                                                   
                            this.getParent().close();                                                                                                                                                                                                          
                        },                                                                                                                                                                                                                                     
                        text: "Close"                                                                                                                                                                                                                          
                    })                                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAfterRendering: function (oEvent) {                                                                                                                                                                                                              
                let oControl = this.getView().byId("listReportFilter");                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                oControl.addEventDelegate({                                                                                                                                                                                                                    
                    onAfterRendering: function (oEvent) {                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        let oText = this.getOwnerComponent().getModel("i18n").getResourceBundle();                                                                                                                                                             
                        oEvent.srcControl._oSearchButton.setText(oText.getText("execButton"));                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            downloadXml: function (oEvent) {                                                                                                                                                                                                                   
                let oView = this.getView();                                                                                                                                                                                                                    
                let oDialog = sap.ui.core.Fragment.load({                                                                                                                                                                                                      
                    id: oView.getId(),                                                                                                                                                                                                                         
                    name: "br.com.trescoracoes.xmldownload.ext.view.download",                                                                                                                                                                                 
                    controller: this                                                                                                                                                                                                                           
                }).then(function (oDialog) {                                                                                                                                                                                                                   
                    oView.addDependent(oDialog);                                                                                                                                                                                                               
                    return oDialog;                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                oDialog.then(function (oDialog) { oDialog.open() });                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onClose: function (oEvent) {                                                                                                                                                                                                                       
                this.byId("downloadDialog").close();                                                                                                                                                                                                           
                this.byId("downloadDialog").destroy();                                                                                                                                                                                                         
                this.getView().removeAllDependents();                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAccept: function (oEvent) {                                                                                                                                                                                                                      
                this.aMessages.length = 0;                                                                                                                                                                                                                     
                let oInput = this.getView().byId("path");                                                                                                                                                                                                      
                let oControl = this.getView().byId("pnlOptions");                                                                                                                                                                                              
                let bInline = oControl.getItems().length > 1 ? false : true;                                                                                                                                                                                   
                let sServiceUrl = this.getView().getModel("fileService").sServiceUrl;                                                                                                                                                                          
                let aPromises = [];                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                if (!oInput.getValue() && this.byId("rbServer").getSelected()) {                                                                                                                                                                               
                    oInput.setValue("/usr/sap/tmp/");                                                                                                                                                                                                          
                    // oInput.setRequired(true);                                                                                                                                                                                                               
                    // sap.m.MessageBox.error(this.getView().getModel("i18n").getResourceBundle().getText("ServerPathMessage"), { title: this.getView().getModel("i18n").getResourceBundle().getText("ServerPathTitle"), actions: sap.m.MessageBox.Action.CLOS+
E });                                                                                                                                                                                                                                                          
                    // return;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                for (let oObj of oControl.getItems()) {                                                                                                                                                                                                        
                    if (oObj instanceof sap.m.CheckBox && oObj.getSelected()) {                                                                                                                                                                                
                        switch (oObj.getId().split("--").pop()) {                                                                                                                                                                                              
                            case "cbDanfe":                                                                                                                                                                                                                    
                                for (let oParam of this.buildParam("downloadNfes", false)) {                                                                                                                                                                   
                                    aPromises.push(this.downloadNfe(window.location.origin + sServiceUrl, oParam));                                                                                                                                            
                                }                                                                                                                                                                                                                              
                                break;                                                                                                                                                                                                                         
                            case "cbCte":                                                                                                                                                                                                                      
                                for (let oParam of this.buildParam("downloadCtes", false)) {                                                                                                                                                                   
                                    aPromises.push(this.downloadCte(window.location.origin + sServiceUrl, oParam));                                                                                                                                            
                                }                                                                                                                                                                                                                              
                                break;                                                                                                                                                                                                                         
                            default:                                                                                                                                                                                                                           
                                break;                                                                                                                                                                                                                         
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                this.onClose();                                                                                                                                                                                                                                
                this.getView().setBusy(true);                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                    
                for (let oPromise of aPromises) {                                                                                                                                                                                                              
                    oExtApi.securedExecution(oPromise.then(this.download.bind(this), this.handleMessages.bind(this)).finally(this.showMessages.bind(this)), { busy: { set: true, check: false }, sActionLabel: "Log de solicitação" });                        
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Promise.all(aPromises).then(this.download.bind(this), this.handleMessages.bind(this));                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            download: function (sServiceUrl) {                                                                                                                                                                                                                 
                sap.m.URLHelper.redirect(sServiceUrl + "/$value", true);                                                                                                                                                                                       
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            downloadNfe: function (sServiceUrl, oParam) {                                                                                                                                                                                                      
                return new Promise(function (fnResolve, fnReject) {                                                                                                                                                                                            
                    this.getView().getModel("fileService").read("/xmlCheckNfeSet(Docnum='" + oParam.docnum + "',Filepath='" + encodeURIComponent(oParam.filepath) + "',Local=" + oParam.server + ")", {                                                        
                        success: function (oData, response) {                                                                                                                                                                                                  
                            if (!oData.Filepath)                                                                                                                                                                                                               
                                fnResolve(sServiceUrl + "/xmlDownloadNfes" + encodeURIComponent(JSON.stringify(oParam).replaceAll("\":", "=").replaceAll(",\"", ",").replaceAll("{\"", "(").replaceAll("}", ")").replaceAll("\"", "\'")));                     
                            else                                                                                                                                                                                                                               
                                fnReject({ type: "Success", message: "XML Docnum " + oData.Docnum + " gravado com sucesso na pasta " + oParam.filepath, param: oData.Docnum });                                                                                
                        },                                                                                                                                                                                                                                     
                        error: function (oErro) {                                                                                                                                                                                                              
                            let oMsg = JSON.parse(oErro.responseText);                                                                                                                                                                                         
                            oMsg.type = "Error";                                                                                                                                                                                                               
                            fnReject(oMsg);                                                                                                                                                                                                                    
                        }                                                                                                                                                                                                                                      
                    })                                                                                                                                                                                                                                         
                }.bind(this))                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            downloadCte: function (sServiceUrl, oParam) {                                                                                                                                                                                                      
                return new Promise(function (fnResolve, fnReject) {                                                                                                                                                                                            
                    this.getView().getModel("fileService").read("/xmlCheckCteSet(Docnum='" + oParam.docnum + "',Filepath='" + encodeURIComponent(oParam.filepath) + "',Local=" + oParam.server + ")", {                                                        
                        success: function (oData, response) {                                                                                                                                                                                                  
                            if (!oData.Filepath)                                                                                                                                                                                                               
                                fnResolve(sServiceUrl + "/xmlDownloadCtes" + encodeURIComponent(JSON.stringify(oParam).replaceAll("\":", "=").replaceAll(",\"", ",").replaceAll("{\"", "(").replaceAll("}", ")").replaceAll("\"", "\'")));                     
                            else                                                                                                                                                                                                                               
                                fnReject({ type: "Success", message: "XML Docnum " + oData.Docnum + this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("Mensagem") + oParam.filepath, param: oData.Docnum });                               
                        },                                                                                                                                                                                                                                     
                        error: function (oError) {                                                                                                                                                                                                             
                            //sap.m.MessageToast.show(JSON.parse(oErro.responseText).error.message.value);                                                                                                                                                     
                            let oMsg = JSON.parse(oError.responseText);                                                                                                                                                                                        
                            oMsg.type = "Error";                                                                                                                                                                                                               
                            fnReject(oMsg);                                                                                                                                                                                                                    
                        }                                                                                                                                                                                                                                      
                    })                                                                                                                                                                                                                                         
                }.bind(this))                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showMessages: function () {                                                                                                                                                                                                                        
                this.getView().setBusy(false);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                if (this.aMessages.length <= 0) return;                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                let oModel = new sap.ui.model.json.JSONModel();                                                                                                                                                                                                
                oModel.setData(this.aMessages);                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                let oMessageTemplate = new sap.m.MessageItem({                                                                                                                                                                                                 
                    type: "{type}",                                                                                                                                                                                                                            
                    title: "{title}",                                                                                                                                                                                                                          
                    description: "{description}",                                                                                                                                                                                                              
                    subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MensagemErroSubtitulo") + " {subtitle}",                                                                                                                  
                    link: new sap.m.Link({                                                                                                                                                                                                                     
                        text: "{info}",                                                                                                                                                                                                                        
                        href: "{link}",                                                                                                                                                                                                                        
                        target: "_blank"                                                                                                                                                                                                                       
                    })                                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                let oMessageView = new sap.m.MessageView({                                                                                                                                                                                                     
                    showDetailsPageHeader: true,                                                                                                                                                                                                               
                    items: {                                                                                                                                                                                                                                   
                        path: "/",                                                                                                                                                                                                                             
                        template: oMessageTemplate                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                oMessageView.setModel(oModel);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                if (this.oMsgDialog) {                                                                                                                                                                                                                         
                    this.oMsgDialog.removeAllContent();                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                this.oMsgDialog.addContent(oMessageView);                                                                                                                                                                                                      
                this.oMsgDialog.open();                                                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            handleMessages: function (oMsg) {                                                                                                                                                                                                                  
                this.aMessages.push({                                                                                                                                                                                                                          
                    type: oMsg.type,                                                                                                                                                                                                                           
                    title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("Mensagem" + oMsg.type + "Titulo"),                                                                                                                           
                    description: oMsg?.error?.message.value == undefined ? oMsg.message : oMsg?.error?.message.value,                                                                                                                                          
                    subtitle: oMsg?.error?.innererror.transactionid == undefined ? oMsg.param : oMsg?.error?.innererror.transactionid,                                                                                                                         
                    info: oMsg?.error?.innererror.Error_Resolution.SAP_Note.split("(")[1].replace(")", ''),                                                                                                                                                    
                    link: oMsg?.error?.innererror.Error_Resolution.SAP_Note.split("(")[1].replace(")", '')                                                                                                                                                     
                })                                                                                                                                                                                                                                             
                // let oMessage = sap.ui.getCore().getMessageManager();                                                                                                                                                                                        
                // oMessage.registerObject(this.getView(), true);                                                                                                                                                                                              
                // oMessage.addMessages(                                                                                                                                                                                                                       
                //     new sap.ui.core.message.Message({                                                                                                                                                                                                       
                //         message: oErro.error.message.value,                                                                                                                                                                                                 
                //         persistent: true, // create message as transition message                                                                                                                                                                           
                //         type: sap.ui.core.MessageType.Error                                                                                                                                                                                                 
                //     })                                                                                                                                                                                                                                      
                // );                                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onShowInput: function (oEvent) {                                                                                                                                                                                                                   
                let oControl = this.getView().byId("fup");                                                                                                                                                                                                     
                if (oEvent.getSource().getSelectedIndex() === 0) {                                                                                                                                                                                             
                    oControl.setVisible(false); return;                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                oControl.setVisible(true);                                                                                                                                                                                                                     
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            serviceParamFactory(bInline) {                                                                                                                                                                                                                     
                let aParam = [];                                                                                                                                                                                                                               
                let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                    
                for (let ctx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                               
                    let oParam = {};                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    oParam.inline = bInline;                                                                                                                                                                                                                   
                    oParam.server = this.byId("rbServer").getSelected();                                                                                                                                                                                       
                    oParam.filepath = this.byId("path").getValue();                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                    oParam.docnum = ctx.getObject().docnum;                                                                                                                                                                                                    
                    aParam.push(oParam);                                                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                return aParam;                                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            paramNfeFactory: function (bInline) {                                                                                                                                                                                                              
                return this.serviceParamFactory(bInline);                                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            paramCteFactory: function (bInline) {                                                                                                                                                                                                              
                return this.serviceParamFactory(bInline);                                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            buildParam: function (sEntity, bInline) {                                                                                                                                                                                                          
                let aParam;                                                                                                                                                                                                                                    
                switch (sEntity) {                                                                                                                                                                                                                             
                    case "downloadNfes":                                                                                                                                                                                                                       
                        aParam = this.paramNfeFactory(bInline);                                                                                                                                                                                                
                    case "downloadCtes":                                                                                                                                                                                                                       
                        aParam = this.paramCteFactory(bInline);                                                                                                                                                                                                
                    default:                                                                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
                return aParam;                                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
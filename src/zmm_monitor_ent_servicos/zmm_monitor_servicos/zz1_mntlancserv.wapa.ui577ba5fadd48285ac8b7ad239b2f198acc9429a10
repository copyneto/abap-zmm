sap.ui.define(                                                                                                                                                                                                                                                 
    ["sap/m/PDFViewer"],                                                                                                                                                                                                                                       
function (PDFViewer){                                                                                                                                                                                                                                          
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return {                                                                                                                                                                                                                                                   
        DwldPdf: function(oEvent) {                                                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Recupa referência à tabela do relatório                                                                                                                                                                                                            
            =================================================================== */                                                                                                                                                                             
            //var oHeader = sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getSelectedItems();                                                                                                                                                    
            var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Verifica se alguma linha foi selecionada                                                                                                                                                                                                           
            =================================================================== */                                                                                                                                                                             
            if (!oSelection.length) {                                                                                                                                                                                                                          
                sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                       
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                     
            =================================================================== */                                                                                                                                                                             
            var oDownloadDialog = new sap.m.Dialog({                                                                                                                                                                                                           
                contentWidth: "300px",                                                                                                                                                                                                                         
                resizable: true,                                                                                                                                                                                                                               
                type: "Message"                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
            oDownloadDialog.setTitle("Download");                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Texto do Pop-up                                                                                                                                                                                                                                    
            =================================================================== */                                                                                                                                                                             
            if( oSelection.length == 1 ){                                                                                                                                                                                                                      
                var oText = new sap.m.Text({ text: "Deseja baixar os anexos do documento selecionado?" });                                                                                                                                                     
            }else{                                                                                                                                                                                                                                             
                var oText = new sap.m.Text({ text: "Deseja baixar os anexos dos " + oSelection.length + " documentos selecionados?" });                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Cria botão para a donwload do arquivo                                                                                                                                                                                                              
            =================================================================== */                                                                                                                                                                             
            var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                            
                text: 'Baixar',                                                                                                                                                                                                                                
                type: 'Accept',                                                                                                                                                                                                                                
                press: function () {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    oDownloadDialog.close();                                                                                                                                                                                                                   
                    oDownloadDialog.destroy();                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    var oServiceUrl = "/sap/opu/odata/SAP/ZMM_MONITOR_SERVICOS_SRV/";                                                                                                                                                                          
                    var oModel = new sap.ui.model.odata.ODataModel(oServiceUrl);                                                                                                                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Loop das linhas selecionadas                                                                                                                                                                                                               
                    =================================================================== */                                                                                                                                                                     
                    for (let i = 0; i < oSelection.length; i++) {                                                                                                                                                                                              
                        /* ===================================================================&nbsp;                                                                                                                                                           
                        Busca as chaves dos anexos contidos em um único registro                                                                                                                                                                               
                        =================================================================== */                                                                                                                                                                 
                        var oObject = oSelection[i].getObject();                                                                                                                                                                                               
                        var vSourceRead = "GetLinesSet(NrNf='" + oObject.NrNf + "',CnpjCpf='" + oObject.CnpjCpf + "')"                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        var promise = function(){                                                                                                                                                                                                              
                            return new Promise(function(resolve, reject){                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                               
                                oModel.read(vSourceRead, {                                                                                                                                                                                                     
                                    success: function (oData) {                                                                                                                                                                                                
                                        if (!oData.Lines) {                                                                                                                                                                                                    
                                            return;                                                                                                                                                                                                            
                                        }                                                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
                                    /* ===================================================================&nbsp;                                                                                                                                               
                                    Split da chave dos itens                                                                                                                                                                                                   
                                    =================================================================== */                                                                                                                                                     
                                        const myArray = oData.Lines.split(";");                                                                                                                                                                                
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
                                        for (let vI = 0; vI < myArray.length ; vI++) {                                                                                                                                                                         
                                            var oSource = oServiceUrl + "AnexoSet(NrNf='" + oData.NrNf + "',CnpjCpf='" + oData.CnpjCpf + "',Linha='" + myArray[vI] +"')/$value";                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n+
bsp;&nbsp;                                                                                                                                                                                                                                                     
                                            var oPDFViewer = new PDFViewer();                                                                                                                                                                                  
                                            this.getView().addDependent(oPDFViewer);                                                                                                                                                                           
                                            oPDFViewer.setSource(oSource);                                                                                                                                                                                     
                                            oPDFViewer.downloadPDF();                                                                                                                                                                                          
                                        }                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                        resolve();                                                                                                                                                                                                             
                                    }.bind(this),                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                    error: function (error) {                                                                                                                                                                                                  
                                        reject();                                                                                                                                                                                                              
                                    }.bind(this)                                                                                                                                                                                                               
                                });&nbsp;&nbsp;                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                            }.bind(this))                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        }.bind(this)                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                        this.extensionAPI.securedExecution(                                                                                                                                                                                                    
                            promise,                                                                                                                                                                                                                           
                            {                                                                                                                                                                                                                                  
                                busy: {                                                                                                                                                                                                                        
                                    set: true,                                                                                                                                                                                                                 
                                    check: false                                                                                                                                                                                                               
                                },                                                                                                                                                                                                                             
                                sActionLabel: "Download"                                                                                                                                                                                                       
                            }                                                                                                                                                                                                                                  
                        );                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Cria botão de cancelar                                                                                                                                                                                                                             
            =================================================================== */                                                                                                                                                                             
            var oCancelButton = new sap.m.Button({                                                                                                                                                                                                             
                text: 'Cancelar',                                                                                                                                                                                                                              
                type: 'Reject',                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                press: function () {                                                                                                                                                                                                                           
                    oDownloadDialog.close();                                                                                                                                                                                                                   
                    oDownloadDialog.destroy();                                                                                                                                                                                                                 
                    this.getView().removeAllDependents();                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                          
            =================================================================== */                                                                                                                                                                             
            oDownloadDialog.addContent(oText);                                                                                                                                                                                                                 
            oDownloadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                     
            oDownloadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                      
            oDownloadDialog.open();                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        showLogs: function(oEvent) {&nbsp;                                                                                                                                                                                                                     
            var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            var lo_model = oSelection[0].getObject();                                                                                                                                                                                                          
            var lv_externalref = lo_model.Empresa + lo_model.Filial + lo_model.Lifnr + lo_model.NrNf;                                                                                                                                                          
                                                                                                                                                                                                                                                               
            sap.ushell.Container.getServiceAsync('CrossApplicationNavigation')                                                                                                                                                                                 
                .then(function(res){                                                                                                                                                                                                                           
                    var hash = res.hrefForExternal({                                                                                                                                                                                                           
                            target: {semanticObject : 'ApplicationLog', action: 'showList'},                                                                                                                                                                   
                            params: {                                                                                                                                                                                                                          
                                LogObjectId: 'ZMM_MONITSERV_LANCTO',&nbsp;                                                                                                                                                                                     
                                LogExternalId:lv_externalref,                                                                                                                                                                                                  
                                DateFrom:lo_model.DtLancto.toLocaleDateString().split('/').reverse().join('-')                                                                                                                                                 
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                  
                        });                                                                                                                                                                                                                                    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        var url = window.location.href.split('#')[0] + hash;                                                                                                                                                                                   
                        sap.m.URLHelper.redirect(url, true);                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                      
    };                                                                                                                                                                                                                                                         
});                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
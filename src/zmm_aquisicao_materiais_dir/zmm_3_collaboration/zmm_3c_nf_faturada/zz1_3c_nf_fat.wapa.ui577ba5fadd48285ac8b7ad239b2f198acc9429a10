sap.ui.define(["sap/m/PDFViewer"],                                                                                                                                                                                                                             
    function (PDFViewer) {                                                                                                                                                                                                                                     
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            onActionDownloadZip: function (oEvent) {                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupera primeira linha selecionada                                                                                                                                                                                                            
                =================================================================== */                                                                                                                                                                         
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica as linhas selecionadas                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                   
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                   Configura Serviço OData onde será extraído os dados                                                                                                                                                                                         
                   =================================================================== */                                                                                                                                                                      
                var vServiceUrl = "/sap/opu/odata/sap/ZUI_O2_3C_NF_FATURADA";                                                                                                                                                                                  
                var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama Serviço                                                                                                                                                                                                                                  
                =================================================================== */                                                                                                                                                                         
                oModel.read("/ZI_MM_3C_VH_PASTA_SERVIDOR", {                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    success: function (oData) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        switch (oData.results.length) {                                                                                                                                                                                                        
                            case 0:                                                                                                                                                                                                                            
                                sap.m.MessageBox.error('Nenhum diretório de servidor cadastrado no parâmetro: MM / 3COLLABORATION / PASTASERV');                                                                                                               
                                break;                                                                                                                                                                                                                         
                            case 1:                                                                                                                                                                                                                            
                                this.downloadZipPopUp(oData.results);                                                                                                                                                                                          
                                break;                                                                                                                                                                                                                         
                            default:                                                                                                                                                                                                                           
                                sap.m.MessageBox.error('Favor cadastrar apenas um diretório de servidor no parâmetro: MM / 3COLLABORATION / PASTASERV');                                                                                                       
                                break;                                                                                                                                                                                                                         
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    }.bind(this),                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                    error: function (oError) {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                        sap.m.MessageBox.error('Nenhum diretório de servidor cadastrado no parâmetro: MM / 3COLLABORATION / PASTASERV');                                                                                                                       
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            downloadZipPopUp: function (Results) {                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                var that = this                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupa referência à tabela do relatório                                                                                                                                                                                                        
                =================================================================== */                                                                                                                                                                         
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica se alguma linha foi selecionada                                                                                                                                                                                                       
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhuma linha selecionado.");                                                                                                                                                                                     
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var oContent = new sap.ui.layout.VerticalLayout({                                                                                                                                                                                              
                    width: '100%',                                                                                                                                                                                                                             
                    content: [                                                                                                                                                                                                                                 
                        new sap.m.Text({ text: "Selecione o tipo de download desejado" }),                                                                                                                                                                     
                        new sap.m.Text({ text: ' ' }),                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                        new sap.m.RadioButtonGroup({                                                                                                                                                                                                           
                            id: "rbg2",                                                                                                                                                                                                                        
                            columns: 2,                                                                                                                                                                                                                        
                            select: this.checkboxFile,                                                                                                                                                                                                         
                            buttons: [                                                                                                                                                                                                                         
                                new sap.m.RadioButton({                                                                                                                                                                                                        
                                    id: "local",                                                                                                                                                                                                               
                                    text: "Local"                                                                                                                                                                                                              
                                }),                                                                                                                                                                                                                            
                                new sap.m.RadioButton({                                                                                                                                                                                                        
                                    id: "servidor",                                                                                                                                                                                                            
                                    text: "Servidor"                                                                                                                                                                                                           
                                })                                                                                                                                                                                                                             
                            ]                                                                                                                                                                                                                                  
                        }),                                                                                                                                                                                                                                    
                        new sap.m.Text({ text: ' ' }),                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                        new sap.ui.layout.VerticalLayout({                                                                                                                                                                                                     
                            id: 'servidorContent',                                                                                                                                                                                                             
                            width: '100%',                                                                                                                                                                                                                     
                            content: [                                                                                                                                                                                                                         
                                new sap.m.Label({ text: "Diretório Servidor" }),                                                                                                                                                                               
                                new sap.m.Input('inServidor', {                                                                                                                                                                                                
                                    width: '100%',                                                                                                                                                                                                             
                                    value: Results[0].ServerFolder,                                                                                                                                                                                            
                                    editable: false                                                                                                                                                                                                            
                                }),                                                                                                                                                                                                                            
                            ]                                                                                                                                                                                                                                  
                        })                                                                                                                                                                                                                                     
                    ]                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                var pressDialog = new sap.m.Dialog({                                                                                                                                                                                                           
                    type: 'Message',                                                                                                                                                                                                                           
                    title: "Baixar ZIP",                                                                                                                                                                                                                       
                    resizable: true,                                                                                                                                                                                                                           
                    draggable: true,                                                                                                                                                                                                                           
                    titleAlignment: sap.m.TitleAlignment.Center,                                                                                                                                                                                               
                    content: oContent,                                                                                                                                                                                                                         
                    beginButton: new sap.m.Button({                                                                                                                                                                                                            
                        type: sap.m.ButtonType.Emphasized,                                                                                                                                                                                                     
                        text: "Download",                                                                                                                                                                                                                      
                        press: function () {                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            pressDialog.close();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            if (sap.ui.getCore().byId('local').getSelected()) {                                                                                                                                                                                
                                that.localDownloadZipFile();                                                                                                                                                                                                   
                            } else {                                                                                                                                                                                                                           
                                var directory = sap.ui.getCore().byId('inServidor').getValue();                                                                                                                                                                
                                that.serverDownloadZipFile(directory);                                                                                                                                                                                         
                            }                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                    }),                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    endButton: new sap.m.Button({                                                                                                                                                                                                              
                        text: "Cancelar",                                                                                                                                                                                                                      
                        press: function () {                                                                                                                                                                                                                   
                            pressDialog.close();                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                    }),                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    afterClose: function () {                                                                                                                                                                                                                  
                        pressDialog.destroy();                                                                                                                                                                                                                 
                    },                                                                                                                                                                                                                                         
                    contentWidth: "20%",                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                pressDialog.open();                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                sap.ui.getCore().byId("servidorContent").setVisible(false);                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            checkboxFile: function (oEvent) {                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                if (oEvent.mParameters.selectedIndex == 0) {                                                                                                                                                                                                   
                    sap.ui.getCore().byId("servidorContent").setVisible(false);                                                                                                                                                                                
                } else {                                                                                                                                                                                                                                       
                    sap.ui.getCore().byId("servidorContent").setVisible(true);                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            localDownloadZipFile: function () {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                // Cada 50 registros será um arquivo novo                                                                                                                                                                                                      
                let div = 50;                                                                                                                                                                                                                                  
                let tItems = {};                                                                                                                                                                                                                               
                for (let i = 0; i < oItems.length; i++) {                                                                                                                                                                                                      
                    if (!tItems[Math.floor(i / div)]) {                                                                                                                                                                                                        
                        tItems[Math.floor(i / div)] = [];                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                    tItems[Math.floor(i / div)].push(oItems[i].getObject());                                                                                                                                                                                   
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                for (let i = 0; i < Math.ceil(oItems.length / div); i++) {                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    var vDocnum = tItems[i].reduce(function (sDocnum, oItems) {                                                                                                                                                                                
                        return sDocnum + oItems.NumRegistro + ';';                                                                                                                                                                                             
                    }, '');                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    var vDoctype = tItems[i].reduce(function (sDoctype, oItems) {                                                                                                                                                                              
                        return sDoctype + oItems.Doctype + ';';                                                                                                                                                                                                
                    }, '');                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    var vGuid = tItems[i].reduce(function (sGuid, oItems) {                                                                                                                                                                                    
                        return sGuid + oItems.Guid + ';';                                                                                                                                                                                                      
                    }, '');                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    //window.setInterval(this.localDownloadZipFileInterval(vDocnum, vDoctype, vGuid), i*1000);                                                                                                                                                 
                    this.sync_wait(1000);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    var vEntitySet = "localDownloadSet(Docnum='" + vDocnum + "',Doctype='" + vDoctype + "',Guid='" + vGuid + "')/$value";                                                                                                                      
                    var vServiceUrl = "/sap/opu/odata/SAP/ZMM_3C_NF_FATURADA_SRV/";                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                    var oSource = vServiceUrl + vEntitySet;                                                                                                                                                                                                    
                    var oPDFViewer = new PDFViewer();                                                                                                                                                                                                          
                    this.getView().addDependent(oPDFViewer);                                                                                                                                                                                                   
                    oPDFViewer.setSource(oSource);                                                                                                                                                                                                             
                    oPDFViewer.downloadPDF();                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            serverDownloadZipFile: function (directory) {                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                var vEntitySet = "serverDownloadSet";                                                                                                                                                                                                          
                var vServiceUrl = "/sap/opu/odata/SAP/ZMM_3C_NF_FATURADA_SRV/";                                                                                                                                                                                
                var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // Cada 100 registros será um arquivo novo                                                                                                                                                                                                     
                let div = 50;                                                                                                                                                                                                                                  
                let tItems = {};                                                                                                                                                                                                                               
                for (let i = 0; i < oItems.length; i++) {                                                                                                                                                                                                      
                    if (!tItems[Math.floor(i / div)]) {                                                                                                                                                                                                        
                        tItems[Math.floor(i / div)] = [];                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                    tItems[Math.floor(i / div)].push(oItems[i].getObject());                                                                                                                                                                                   
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                for (let i = 0; i < Math.ceil(oItems.length / div); i++) {                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    let aFilters = [];                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    for (let j = 0; j < tItems[i].length; j++) {                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        var oFilter = new sap.ui.model.Filter('Docnum', sap.ui.model.FilterOperator.EQ, tItems[i][j].NumRegistro);                                                                                                                             
                        aFilters.push(oFilter);                                                                                                                                                                                                                
                        var oFilter = new sap.ui.model.Filter('Doctype', sap.ui.model.FilterOperator.EQ, tItems[i][j].Doctype);                                                                                                                                
                        aFilters.push(oFilter);                                                                                                                                                                                                                
                        var oFilter = new sap.ui.model.Filter('Guid', sap.ui.model.FilterOperator.EQ, tItems[i][j].Guid);                                                                                                                                      
                        aFilters.push(oFilter);                                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Espera 5 segundos antes de fazer a proxima chamada  do serviço                                                                                                                                                                             
                    =================================================================== */                                                                                                                                                                     
                    /*                                                                                                                                                                                                                                         
                    var waitFunction = async function () {                                                                                                                                                                                                     
                        // first code block ...                                                                                                                                                                                                                
                        await this.delay(5000);                                                                                                                                                                                                                
                        // some more code, executed 5 seconds after the first code block finishes                                                                                                                                                              
                    };                                                                                                                                                                                                                                         
                    */                                                                                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    this.sync_wait(1000);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Chama Gateway para processar logs                                                                                                                                                                                                          
                    =================================================================== */                                                                                                                                                                     
                    var fnFunction = function () {                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                        return new Promise(function (showSuccessMessage, showErrorMessage) {                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            oModel.read(vEntitySet, {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                filters: aFilters,                                                                                                                                                                                                             
                                success: function (oData, oResponse) {                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                    showSuccessMessage();                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                    sap.m.MessageToast.show(oData.results[0].Message);                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                }.bind(this),                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                error: function (oError) {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                    showErrorMessage();                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                    // Recupera texto da mensagem                                                                                                                                                                                              
                                    let aMessage = [];                                                                                                                                                                                                         
                                    for (const res of oError.response.body.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                     
                                        aMessage.push(res[1]);                                                                                                                                                                                                 
                                    }                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                    if (aMessage.length == 0) {                                                                                                                                                                                                
                                        sap.m.MessageBox.error('Falha na solicitação HTTP: Número de registros muito grande, utilizar programa JOB');                                                                                                          
                                        return;                                                                                                                                                                                                                
                                    }                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                    this.showLog(oError.response.body);                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                }.bind(this),                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            });                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        }.bind(this))                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                    /*                                                                                                                                                                                                                                         
                    this.extensionAPI.securedExecution(waitFunction,                                                                                                                                                                                           
                        {                                                                                                                                                                                                                                      
                            busy: {                                                                                                                                                                                                                            
                                set: true,                                                                                                                                                                                                                     
                                check: false                                                                                                                                                                                                                   
                            },                                                                                                                                                                                                                                 
                            sActionLabel: "Mensagens"                                                                                                                                                                                                          
                        });                                                                                                                                                                                                                                    
                    */                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    this.extensionAPI.securedExecution(fnFunction,                                                                                                                                                                                             
                        {                                                                                                                                                                                                                                      
                            busy: {                                                                                                                                                                                                                            
                                set: true,                                                                                                                                                                                                                     
                                check: false                                                                                                                                                                                                                   
                            },                                                                                                                                                                                                                                 
                            sActionLabel: "Mensagens"                                                                                                                                                                                                          
                        });                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showSuccessMessage: function (sMessage) {                                                                                                                                                                                                          
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showErrorMessage: function (sMessage) {                                                                                                                                                                                                            
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showLog: function (sMessage) {                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                // Recupera texto da mensagem                                                                                                                                                                                                                  
                let aMessage = [];                                                                                                                                                                                                                             
                for (const res of sMessage.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                                                     
                    aMessage.push(res[1]);                                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Recupera o tipo da mensagem                                                                                                                                                                                                                 
                let aSeverity = [];                                                                                                                                                                                                                            
                for (const res of sMessage.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)) {                                                                                                                                                                   
                    switch (res[1]) {                                                                                                                                                                                                                          
                        case "error":                                                                                                                                                                                                                          
                            aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                                     
                            break;                                                                                                                                                                                                                             
                        case "info":                                                                                                                                                                                                                           
                            aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                                               
                            break;                                                                                                                                                                                                                             
                        case "success":                                                                                                                                                                                                                        
                            aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                                   
                            break;                                                                                                                                                                                                                             
                        case "warning":                                                                                                                                                                                                                        
                            aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                                   
                            break;                                                                                                                                                                                                                             
                        default:                                                                                                                                                                                                                               
                            aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                                      
                            break;                                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Exibe mensagem                                                                                                                                                                                                                              
                for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    if (aMessage[i] == "Ocorreu uma exceção") {                                                                                                                                                                                                
                        continue;                                                                                                                                                                                                                              
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    //MessageManager.addMessages(new sap.ui.core.message.Message({                                                                                                                                                                             
                    sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                                         
                        message: aMessage[i],                                                                                                                                                                                                                  
                        persistent: true, // create message as transition message                                                                                                                                                                              
                        type: aSeverity[i]                                                                                                                                                                                                                     
                    }));                                                                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            delay: function (time) {                                                                                                                                                                                                                           
                return new Promise(resolve => setTimeout(resolve, time));                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            sync_wait: function (ms) {                                                                                                                                                                                                                         
                var start = new Date().getTime();                                                                                                                                                                                                              
                var end = start;                                                                                                                                                                                                                               
                while(end < start + ms) {                                                                                                                                                                                                                      
                  end = new Date().getTime();                                                                                                                                                                                                                  
               }                                                                                                                                                                                                                                               
             }                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
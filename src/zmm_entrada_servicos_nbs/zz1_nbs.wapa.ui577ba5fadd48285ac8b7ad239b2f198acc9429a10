sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/export/Spreadsheet",                                                                                                                                                                                                                               
    "sap/ui/export/library",                                                                                                                                                                                                                                   
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    'sap/ui/core/util/Export',                                                                                                                                                                                                                                 
    'sap/ui/core/util/ExportTypeCSV'],                                                                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
    function (Spreadsheet, exportLibrary, JSONModel, Export, ExportTypeCSV, library){                                                                                                                                                                          
        "use strict";                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        var EdmType = exportLibrary.EdmType;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
        return sap.ui.controller("br.com.trescoracoes.zmmnbs.ext.controller.ListReportExt", {                                                                                                                                                                  
            createColumnConfigServ: function () {                                                                                                                                                                                                              
                var aCols = [];                                                                                                                                                                                                                                
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Material',                                                                                                                                                                                                                         
                    property: 'Matnr',                                                                                                                                                                                                                         
                    type: EdmType.String,                                                                                                                                                                                                                      
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'NBS',                                                                                                                                                                                                                              
                    property: 'Nbs',                                                                                                                                                                                                                           
                    type: EdmType.String,                                                                                                                                                                                                                      
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                return aCols;                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
            DownloadExcel: function(oEvent) {                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                var aCols, oSettings, oSheet, aItems, aFilters;                                                                                                                                                                                                
                var vServiceUrl = "/sap/opu/odata/sap/ZUI_O2_MM_NBS";                                                                                                                                                                                          
                var oModel_B = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                if (!this._oTable) {                                                                                                                                                                                                                           
                    this._oTable = this.byId('br.com.trescoracoes.zmmnbs::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_MM_NBS--responsiveTable');                                                                                              
                }&nbsp;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oTable = this._oTable;                                                                                                                                                                                                                     
                var oRowBinding = oTable.getBinding('items');                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                aCols = this.createColumnConfigServ();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                oModel_B.read("/ZC_MM_NBS", {                                                                                                                                                                                                                  
                    filters: aFilters,                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        var items = oData.results;                                                                                                                                                                                                             
                        var oModel = new JSONModel(items)                                                                                                                                                                                                      
                        sap.ui.getCore().setModel(oModel, "Download");                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                        aItems = sap.ui.getCore().getModel("Download").getProperty("/");                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oSettings = {                                                                                                                                                                                                                          
                            workbook: {                                                                                                                                                                                                                        
                                columns: aCols,                                                                                                                                                                                                                
                                /* hierarchyLevel: 'Nome' */                                                                                                                                                                                                   
                            },                                                                                                                                                                                                                                 
                            dataSource: aCols,                                                                                                                                                                                                                 
                            fileName: 'DownloadLayout.xlsx'                                                                                                                                                                                                    
                        };                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oSheet = new Spreadsheet(oSettings);                                                                                                                                                                                                   
                        oSheet.build().finally(function () {                                                                                                                                                                                                   
                            oSheet.destroy();                                                                                                                                                                                                                  
                        });                                                                                                                                                                                                                                    
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        alert('Falha no download');                                                                                                                                                                                                            
                    }.bind(this)                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            UploadExcel: function (oEvent) {                                                                                                                                                                                                                   
                /* ===================================================================&nbsp;                                                                                                                                                                   
                 Cria Dialogo dinamico (pop-up)                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Carregar arquivo Excel");                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define o servico gateway que ser chamado                                                                                                                                                                                                       
                =================================================================== */                                                                                                                                                                         
                var sServiceUrl = "/sap/opu/odata/SAP/ZMM_ENTR_SERV_NBS_SRV/";                                                                                                                                                                                 
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                            
                var sSource = sServiceUrl + "UploadSet";                                                                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara o responsavel pela carga do arquivo                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                          
                    width: "100%",                                                                                                                                                                                                                             
                    fileType: ["xlsx", "xls", "csv"],                                                                                                                                                                                                          
                    typeMissmatch: this.handleTypeMissmatch,                                                                                                                                                                                                   
                    uploadComplete: function (oEvent) {                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        // Atualiza tabela do relatorio apos carga                                                                                                                                                                                             
                        var sId = this.oView.sId + '--responsiveTable';                                                                                                                                                                                        
                        var oTable = this.byId(sId);                                                                                                                                                                                                           
                        oTable.getModel().refresh(true);                                                                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        // Verifica o retorno da mensagem                                                                                                                                                                                                      
                        if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '201'||                                                                                                                                                                                               
                            oEvent.mParameters.status == '204') {                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                            sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                           
                        }                                                                                                                                                                                                                                      
                        else {                                                                                                                                                                                                                                 
                         //   alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                                    
                         sap.m.MessageToast.show("Erro ao importar, verificar os materiais do arquivo");                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                       
                        }                                                                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                    }.bind(this)                                                                                                                                                                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                });                                                                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Define parametros                                                                                                                                                                                                                                  
            =================================================================== */                                                                                                                                                                             
                oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                      
                oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                           
                oFileUploader.setSendXHR(true);                                                                                                                                                                                                                
                oFileUploader.setUseMultipart(false);                                                                                                                                                                                                          
                oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                        
                    name: "x-csrf-token",                                                                                                                                                                                                                      
                    value: oModel.getSecurityToken()                                                                                                                                                                                                           
                });                                                                                                                                                                                                                                            
                oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                   
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botao para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Upload',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        // Verifica se arquivo foi informado                                                                                                                                                                                                   
                        var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                           
                        var file = domRef.files[0];                                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        if (oFileUploader.getValue() === '') {                                                                                                                                                                                                 
                            sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                            
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                          
                            name: "Content-Type",                                                                                                                                                                                                              
                            value: file.type                                                                                                                                                                                                                   
                        });                                                                                                                                                                                                                                    
                        oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                         
                            name: "SLUG",                                                                                                                                                                                                                      
                            value: oFileUploader.getValue()                                                                                                                                                                                                    
                        }));                                                                                                                                                                                                                                   
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        oFileUploader.upload();                                                                                                                                                                                                                
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Cria botão de cancelar                                                                                                                                                                                                                     
                    =================================================================== */                                                                                                                                                                     
                    var oCancelButton = new sap.m.Button({                                                                                                                                                                                                     
                        text: 'Cancelar',                                                                                                                                                                                                                      
                        type: 'Reject',                                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        press: function () {                                                                                                                                                                                                                   
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                            oUploadDialog.close();                                                                                                                                                                                                             
                            oUploadDialog.destroy();                                                                                                                                                                                                           
                            this.getView().removeAllDependents();                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                        }.bind(this)                                                                                                                                                                                                                           
                    });                                                                                                                                                                                                                                        
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama dialogo com a logica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                       
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            handleTypeMissmatch: function (oEvent) {                                                                                                                                                                                                           
                var aFileTypes = oEvent.getSource().getFileType();                                                                                                                                                                                             
                jQuery.each(aFileTypes, function (key, value) { aFileTypes[key] = "*." + value; });                                                                                                                                                            
                var sSupportedFileTypes = aFileTypes.join(", ");                                                                                                                                                                                               
                sap.m.MessageToast.show("Tipo de arquivo *." + oEvent.getParameter("fileType") +                                                                                                                                                               
                    " nao ? suportado. Escolha um dos tipos a seguir: " +                                                                                                                                                                                      
                    sSupportedFileTypes);                                                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                 
        });                                                                                                                                                                                                                                                    
    });                                                                                                                                                                                                                                                        
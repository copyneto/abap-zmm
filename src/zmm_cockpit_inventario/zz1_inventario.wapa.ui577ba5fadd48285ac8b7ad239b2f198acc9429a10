sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/export/Spreadsheet",                                                                                                                                                                                                                               
    "sap/ui/export/library"                                                                                                                                                                                                                                    
],                                                                                                                                                                                                                                                             
    function (spreadsheet, library) {                                                                                                                                                                                                                          
        "use strict";                                                                                                                                                                                                                                          
        return sap.ui.controller("br.com.trescoracoes.cockpitinventario.ext.controller.ListReportExt", {                                                                                                                                                       
                                                                                                                                                                                                                                                               
            onActionDownloadLayout: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Monta layout de colunas                                                                                                                                                                                                                        
                =================================================================== */                                                                                                                                                                         
                var aCols = [];                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Planta',                                                                                                                                                                                                                           
                    property: 'Planta',                                                                                                                                                                                                                        
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Data da Contagem',                                                                                                                                                                                                                 
                    property: 'DataDaContagem',                                                                                                                                                                                                                
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Deposito',                                                                                                                                                                                                                         
                    property: 'Deposito',                                                                                                                                                                                                                      
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Material',                                                                                                                                                                                                                         
                    property: 'Material',                                                                                                                                                                                                                      
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Lote',                                                                                                                                                                                                                             
                    property: 'Lote',                                                                                                                                                                                                                          
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'Contagem',                                                                                                                                                                                                                         
                    property: 'Contagem',                                                                                                                                                                                                                      
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                aCols.push({                                                                                                                                                                                                                                   
                    label: 'UM',                                                                                                                                                                                                                               
                    property: 'UM',                                                                                                                                                                                                                            
                    type: library.EdmType.String                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara configurações                                                                                                                                                                                                                          
                =================================================================== */                                                                                                                                                                         
                var oSettings = {                                                                                                                                                                                                                              
                    workbook: { columns: aCols },                                                                                                                                                                                                              
                    dataSource: [''],                                                                                                                                                                                                                          
                    count: 1,                                                                                                                                                                                                                                  
                    fileName: 'Inventario.xlsx'                                                                                                                                                                                                                
                };                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria planilha&nbsp;                                                                                                                                                                                                                            
                =================================================================== */                                                                                                                                                                         
                var oSheet = new spreadsheet(oSettings);                                                                                                                                                                                                       
                oSheet.build().finally(function () {                                                                                                                                                                                                           
                    oSheet.destroy();                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onActionUploadFile: function (oEvent) {                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                var that = this;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Carregar arquivo Excel");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define o serviço gateway que será chamado                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                var sServiceUrl = "/sap/opu/odata/SAP/ZMM_INVENTARIO_SRV/";                                                                                                                                                                                    
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                            
                var sSource = sServiceUrl + "uploadSet";                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara o responsável pela carga do arquivo                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                          
                    width: "100%",                                                                                                                                                                                                                             
                    fileType: ["xlsx", "xls"],                                                                                                                                                                                                                 
                    typeMissmatch: this.handleTypeMissmatch,                                                                                                                                                                                                   
                    uploadComplete: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        // Atualiza tabela do relatório após carga                                                                                                                                                                                             
                        var sId = this.oView.sId + '--responsiveTable';                                                                                                                                                                                        
                        var oTable = this.byId(sId);                                                                                                                                                                                                           
                        that.templateBaseExtension.getExtensionAPI().refreshTable();                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        // Verifica o retorno da mensagem                                                                                                                                                                                                      
                        if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '201') {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                           
                        }                                                                                                                                                                                                                                      
                        else {                                                                                                                                                                                                                                 
                            if (oEvent.mParameters.response) {                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                if (oEvent.mParameters.responseRaw.search("<message>")) {                                                                                                                                                                      
                                    var sResponse = oEvent.mParameters.responseRaw.split("<message>")[1].split("</message>")[0];                                                                                                                               
                                    alert(sResponse);                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                                else {                                                                                                                                                                                                                         
                                    alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                              
                                }                                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
               Define parâmetros                                                                                                                                                                                                                               
                =================================================================== */                                                                                                                                                                         
                oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                      
                oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                           
                oFileUploader.setSendXHR(true);                                                                                                                                                                                                                
                oFileUploader.setUseMultipart(false);                                                                                                                                                                                                          
                oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                        
                    name: "x-csrf-token",                                                                                                                                                                                                                      
                    value: oModel.getSecurityToken()                                                                                                                                                                                                           
                });                                                                                                                                                                                                                                            
                oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Upload',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        // Verifica se arquivo foi informado                                                                                                                                                                                                   
                        var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                           
                        var file = domRef.files[0];                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        if (oFileUploader.getValue() === '') {                                                                                                                                                                                                 
                            sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                            
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                          
                            name: "Content-Type",                                                                                                                                                                                                              
                            value: file.type                                                                                                                                                                                                                   
                        });                                                                                                                                                                                                                                    
                        oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                         
                            name: "SLUG",                                                                                                                                                                                                                      
                            value: oFileUploader.getValue()                                                                                                                                                                                                    
                        }));                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        oFileUploader.upload();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                       
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            handleTypeMissmatch: function (oEvent) {                                                                                                                                                                                                           
                var aFileTypes = oEvent.getSource().getFileType();                                                                                                                                                                                             
                jQuery.each(aFileTypes, function (key, value) { aFileTypes[key] = "*." + value; });                                                                                                                                                            
                var sSupportedFileTypes = aFileTypes.join(", ");                                                                                                                                                                                               
                sap.m.MessageToast.show("Tipo de arquivo *." + oEvent.getParameter("fileType") +                                                                                                                                                               
                    " não é suportado. Escolha um dos tipos a seguir: " +                                                                                                                                                                                      
                    sSupportedFileTypes);                                                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onActionExportExcel: function (oEvent) {                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
            showLogs: function(oEvent) {                                                                                                                                                                                                                       
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                var lo_model = oSelection[0].getObject();                                                                                                                                                                                                      
                var lv_externalref =  lo_model.ExternalRef;                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                sap.ushell.Container.getServiceAsync('CrossApplicationNavigation')                                                                                                                                                                             
                    .then(function(res){                                                                                                                                                                                                                       
                        var hash = res.hrefForExternal({                                                                                                                                                                                                       
                                target: {semanticObject : 'ApplicationLog', action: 'showList'},                                                                                                                                                               
                                params: {                                                                                                                                                                                                                      
                                    LogObjectId: 'ZMM_INVENT_FIS',                                                                                                                                                                                             
                                    LogExternalId:lv_externalref,                                                                                                                                                                                              
                                    DateFrom:lo_model.DataLanc.toLocaleDateString().split('/').reverse().join('-')                                                                                                                                             
                                }                                                                                                                                                                                                                              
                            });                                                                                                                                                                                                                                
                            var url = window.location.href.split('#')[0] + hash;                                                                                                                                                                               
                            sap.m.URLHelper.redirect(url, true);                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
            onActionEncerrarInventario: function (oEvent) {                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                /* ===================================================================                                                                                                                                                                         
                Recupera dados dos campos das linhas selecionadas                                                                                                                                                                                              
                 =================================================================== */                                                                                                                                                                        
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                var oItemFiscalYear = [];                                                                                                                                                                                                                      
                var oItemPhysicalInventoryDocument = [];                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                for (let i = 0; i < oSelection.length; i++) {                                                                                                                                                                                                  
                    oItemFiscalYear[i] = oSelection[i].getObject().FiscalYear;                                                                                                                                                                                 
                    oItemPhysicalInventoryDocument[i] = oSelection[i].getObject().PhysicalInventoryDocument;                                                                                                                                                   
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================                                                                                                                                                                         
                Verifica se usuário tem permissão para navegação                                                                                                                                                                                               
                =================================================================== */                                                                                                                                                                         
                sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported([                                                                                                                                                          
                    { target: { shellHash: "PhysicalInventoryDocument-changePhysicalInventoryDocumentInWebGUI?FiscalYear=" + oItemFiscalYear + ",PhysicalInventoryDocument=" + oItemPhysicalInventoryDocument } }                                              
                ])                                                                                                                                                                                                                                             
                    .done(function (aResponse) {                                                                                                                                                                                                               
                        aResponse.map(function (elem, index) {                                                                                                                                                                                                 
                            if (elem.supported === true) {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                /* ===================================================================                                                                                                                                                         
                                Chama outro aplicativo                                                                                                                                                                                                         
                                =================================================================== */                                                                                                                                                         
                                var href_parameters = (sap.ushell && sap.ushell.Container &&                                                                                                                                                                   
                                    sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal({                                                                                                                                            
                                        target: { semanticObject: "PhysicalInventoryDocument", action: "changePhysicalInventoryDocumentInWebGUI" },                                                                                                            
                                        params: {                                                                                                                                                                                                              
                                            FiscalYear: oItemFiscalYear,                                                                                                                                                                                       
                                            PhysicalInventoryDocument: oItemPhysicalInventoryDocument                                                                                                                                                          
                                        },                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                    }));                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                sap.m.URLHelper.redirect(href_parameters, false);                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            }                                                                                                                                                                                                                                  
                            else {                                                                                                                                                                                                                             
                                alert('Usuário sem permissão para acessar o link');                                                                                                                                                                            
                            }                                                                                                                                                                                                                                  
                        })                                                                                                                                                                                                                                     
                    })                                                                                                                                                                                                                                         
                    .fail(function () {                                                                                                                                                                                                                        
                        alert('Falha ao acessar o link');                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
            onActionEstornaDocCont: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                /* ===================================================================                                                                                                                                                                         
                Recupera dados dos campos das linhas selecionadas                                                                                                                                                                                              
                 =================================================================== */                                                                                                                                                                        
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                var oItemFiscalYear = [];                                                                                                                                                                                                                      
                var oItemAccountingDocument = [];                                                                                                                                                                                                              
                var oItemCompanyCode = [];                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                for (let i = 0; i < oSelection.length; i++) {                                                                                                                                                                                                  
                    oItemFiscalYear[i] = oSelection[i].getObject().FiscalYear;                                                                                                                                                                                 
                    oItemAccountingDocument[i] = oSelection[i].getObject().DocComp;                                                                                                                                                                            
                    oItemCompanyCode[i] = oSelection[i].getObject().Empresa;                                                                                                                                                                                   
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================                                                                                                                                                                         
                Verifica se usuário tem permissão para navegação                                                                                                                                                                                               
                =================================================================== */                                                                                                                                                                         
                sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported([                                                                                                                                                          
                    { target: { shellHash: "AccountingDocument-reverseDocument?FiscalYear=" + oItemFiscalYear + ",AccountingDocument=" + oItemAccountingDocument + ",CompanyCode=" + oItemCompanyCode } }                                                      
                ])                                                                                                                                                                                                                                             
                    .done(function (aResponse) {                                                                                                                                                                                                               
                        aResponse.map(function (elem, index) {                                                                                                                                                                                                 
                            if (elem.supported === true) {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                /* ===================================================================                                                                                                                                                         
                                Chama outro aplicativo                                                                                                                                                                                                         
                                =================================================================== */                                                                                                                                                         
                                var href_parameters = (sap.ushell && sap.ushell.Container &&                                                                                                                                                                   
                                    sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal({                                                                                                                                            
                                        target: { semanticObject: "AccountingDocument", action: "reverseDocument" },                                                                                                                                           
                                        params: {                                                                                                                                                                                                              
                                            FiscalYear: oItemFiscalYear,                                                                                                                                                                                       
                                            AccountingDocument: oItemAccountingDocument,                                                                                                                                                                       
                                            CompanyCode: oItemCompanyCode                                                                                                                                                                                      
                                        },                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                    }));                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                sap.m.URLHelper.redirect(href_parameters, false);                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            }                                                                                                                                                                                                                                  
                            else {                                                                                                                                                                                                                             
                                alert('Usuário sem permissão para acessar o link');                                                                                                                                                                            
                            }                                                                                                                                                                                                                                  
                        })                                                                                                                                                                                                                                     
                    })                                                                                                                                                                                                                                         
                    .fail(function () {                                                                                                                                                                                                                        
                        alert('Falha ao acessar o link');                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        });                                                                                                                                                                                                                                                    
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               